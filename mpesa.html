<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M-Pesa STK Push Payment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'mpesa-green': '#4CAF50',
                        'mpesa-dark-green': '#388E3C'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-blue-600 to-purple-700 min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-white shadow-2xl rounded-xl overflow-hidden">
        <div class="bg-mpesa-green text-white p-6 text-center">
            <h2 class="text-2xl font-bold">M-Pesa Payment</h2>
            <p class="text-sm opacity-80">Secure Mobile Money Transaction</p>
        </div>
        <form id="mpesa-form" class="p-6 space-y-4">
            <div>
                <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">
                    Phone Number
                </label>
                <input 
                    type="tel" 
                    id="phone" 
                    name="phone"
                    pattern="254[17][0-9]{8}"
                    title="Enter a valid Kenyan phone number (e.g., 2547XXXXXXXX)"
                    required 
                    placeholder="2547XXXXXXXX" 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-mpesa-green focus:border-transparent transition duration-300"
                >
                <p id="phone-error" class="text-red-500 text-xs mt-1 hidden"></p>
            </div>
            
            <div>
                <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">
                    Amount (KES)
                </label>
                <input 
                    type="number" 
                    id="amount" 
                    name="amount"
                    min="1" 
                    max="70000"
                    required 
                    placeholder="Enter amount" 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-mpesa-green focus:border-transparent transition duration-300"
                >
                <p id="amount-error" class="text-red-500 text-xs mt-1 hidden"></p>
            </div>
            
            <button 
                type="submit" 
                id="submit-btn" 
                class="w-full bg-mpesa-green text-white py-3 rounded-lg font-bold hover:bg-mpesa-dark-green transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-mpesa-green"
            >
                <span id="btn-text">Send Payment</span>
                <span id="spinner" class="hidden ml-2 inline-block w-5 h-5 border-4 border-white border-t-transparent rounded-full animate-spin"></span>
            </button>
            
            <div 
                id="response" 
                class="text-center text-sm font-medium mt-4 p-3 rounded-lg hidden"
            ></div>
        </form>
    </div>

    <script>
        const form = document.getElementById('mpesa-form');
        const phoneInput = document.getElementById('phone');
        const amountInput = document.getElementById('amount');
        const submitBtn = document.getElementById('submit-btn');
        const responseElement = document.getElementById('response');
        const btnText = document.getElementById('btn-text');
        const spinner = document.getElementById('spinner');
        const phoneError = document.getElementById('phone-error');
        const amountError = document.getElementById('amount-error');

        // Validation functions
        function validatePhone(phone) {
            const phoneRegex = /^254[17][0-9]{8}$/;
            return phoneRegex.test(phone);
        }

        function validateAmount(amount) {
            return amount >= 1 && amount <= 70000;
        }

        // Input validation event listeners
        phoneInput.addEventListener('input', () => {
            if (!validatePhone(phoneInput.value)) {
                phoneError.textContent = 'Invalid phone number. Use format 2547XXXXXXXX';
                phoneError.classList.remove('hidden');
                phoneInput.classList.add('border-red-500');
            } else {
                phoneError.classList.add('hidden');
                phoneInput.classList.remove('border-red-500');
            }
        });

        amountInput.addEventListener('input', () => {
            if (!validateAmount(amountInput.value)) {
                amountError.textContent = 'Amount must be between 1 and 70,000 KES';
                amountError.classList.remove('hidden');
                amountInput.classList.add('border-red-500');
            } else {
                amountError.classList.add('hidden');
                amountInput.classList.remove('border-red-500');
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Reset previous states
            responseElement.classList.add('hidden');
            phoneError.classList.add('hidden');
            amountError.classList.add('hidden');

            // Validate inputs
            const isPhoneValid = validatePhone(phoneInput.value);
            const isAmountValid = validateAmount(amountInput.value);

            if (!isPhoneValid || !isAmountValid) {
                if (!isPhoneValid) {
                    phoneError.textContent = 'Invalid phone number. Use format 2547XXXXXXXX';
                    phoneError.classList.remove('hidden');
                    phoneInput.classList.add('border-red-500');
                }
                if (!isAmountValid) {
                    amountError.textContent = 'Amount must be between 1 and 70,000 KES';
                    amountError.classList.remove('hidden');
                    amountInput.classList.add('border-red-500');
                }
                return;
            }

            // Disable submit button and show spinner
            submitBtn.disabled = true;
            btnText.classList.add('hidden');
            spinner.classList.remove('hidden');

            try {
                const response = await fetch('https://denmara.com', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        phoneNumber: phoneInput.value, 
                        amount: amountInput.value 
                    })
                });

                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Received non-JSON response');
                }

                let result;
                try {
                    result = await response.json();
                } catch (parseError) {
                    throw new Error('Failed to parse JSON response');
                }

                // Show response
                responseElement.textContent = response.ok 
                    ? 'Payment request sent successfully!' 
                    : `Error: ${result.error || 'Something went wrong'}`;
                responseElement.classList.remove('hidden');
                responseElement.classList.add(
                    response.ok ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                );
            } catch (error) {
                // Network or parsing errors
                responseElement.textContent = `Error: ${error.message}. Please try again or contact support.`;
                responseElement.classList.remove('hidden');
                responseElement.classList.add('bg-red-100 text-red-800');
                console.error('Full error:', error);
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                btnText.classList.remove('hidden');
                spinner.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
